#!/usr/bin/env bash

set -ex

pushd deployments-diego/${DEPLOYMENT_DIR}/
  source .envrc
popd
export BOSH_DEPLOYMENT

export BOSH_DNS_RUNTIME_CONFIG="${PWD}/bosh-deployment/runtime-configs/dns.yml"
export DIEGO_RELEASE="${PWD}/diego-release"
export CF_MANIFEST="${PWD}/merged-cf-deployment/cf-deployment.yml"
export OPSFILE_DIR="${PWD}/merged-cf-deployment/operations"

export DEPLOYMENT_DIR="${PWD}/deployments-diego/${DEPLOYMENT_DIR}"

bosh_dns_var_file="${DEPLOYMENT_DIR}/bosh-dns-vars.yml"
cf_deployment_var_file="${DEPLOYMENT_DIR}/cf-deployment-vars.yml"
interpolated_manifest="${DEPLOYMENT_DIR}/cf.yml"

bosh log-in

bosh -n upload-stemcell bosh-stemcell/*.tgz

bosh -n interpolate \
  --var-errs \
  --var-errs-unused \
  --vars-file=${bosh_dns_var_file} ${BOSH_DNS_RUNTIME_CONFIG}

bosh -n update-runtime-config \
  --name=dns \
  --vars-file=${bosh_dns_var_file} ${BOSH_DNS_RUNTIME_CONFIG}

if [ "${USE_POSTGRES}" == "true" ]; then
  postgres_ops_files="-o ${OPSFILE_DIR}/test/add-datadog-firehose-nozzle.yml \
    -o ${OPSFILE_DIR}/use-postgres.yml \
    -o ${OPSFILE_DIR}/use-latest-stemcell.yml \
    -o ${DIEGO_RELEASE}/operations/benchmarks/postgres.yml \
    -o ${DEPLOYMENT_DIR}/operations/bbs-benchmark.yml \
    -o ${DEPLOYMENT_DIR}/operations/bbs-benchmark-postgres.yml \
    -o ${DEPLOYMENT_DIR}/operations/overrides.yml \
    -o ${DEPLOYMENT_DIR}/operations/remove-log-cache.yml \
    -o ${DEPLOYMENT_DIR}/operations/rename-deployment-postgres.yml"
  bosh -n interpolate \
    --var-errs \
    --vars-file=${cf_deployment_var_file} ${CF_MANIFEST} \
    ${postgres_ops_files} \
    -o <(cat <<EOF
- type: replace
  path: /releases/name=diego
  value:
    name: diego
    version: create
    url: file://${DIEGO_RELEASE}
EOF
) > ${interpolated_manifest}

  bosh  -d time_rotor_gcp_postgres -n deploy --no-redact ${interpolated_manifest}
else
  ops_files="-o ${OPSFILE_DIR}/test/add-datadog-firehose-nozzle.yml \
    -o ${OPSFILE_DIR}/experimental/use-pxc.yml \
    -o ${OPSFILE_DIR}/use-latest-stemcell.yml \
    -o ${DIEGO_RELEASE}/operations/benchmarks/mysql.yml \
    -o ${DEPLOYMENT_DIR}/operations/bbs-benchmark.yml \
    -o ${DEPLOYMENT_DIR}/operations/overrides.yml \
    -o ${DEPLOYMENT_DIR}/operations/remove-log-cache.yml \
    -o ${DEPLOYMENT_DIR}/operations/disable-pxc-tls.yml \
    -o ${DEPLOYMENT_DIR}/operations/rename-deployment.yml"

  bosh -n interpolate \
    --var-errs \
    --vars-file=${cf_deployment_var_file} ${CF_MANIFEST} \
    ${ops_files} \
    -o <(cat <<EOF
- type: replace
  path: /releases/name=diego
  value:
    name: diego
    version: create
    url: file://${DIEGO_RELEASE}
EOF
) > ${interpolated_manifest}

  bosh  -d time_rotor_gcp -n deploy --no-redact ${interpolated_manifest}
fi
